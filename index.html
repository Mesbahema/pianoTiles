<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>pianoTiles</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/2.4.3/custom/phaser-arcade-physics.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <style>
        body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        canvas {
            position: relative;
            margin: auto;
            right: 0;
            /* transform: scaleX(1.5); */
        }
    </style>
</head>

<body>
    <script>
        var xrec = 4,
            yrec = 4,
            odeToJoy = ['E4', 'E4', 'F4', 'G4',
                        'G4', 'F4', 'E4', 'D4',
                        'C4', 'C4', 'D4', 'E4',
                        'E4', 'D4', 'D4',
                        'E4', 'E4', 'F4', 'G4',
                        'G4', 'F4', 'E4', 'D4',
                        'C4', 'C4', 'D4', 'E4',
                        'E4', 'D4', 'D4',
                        'D4', 'D4', 'E4', 'C4',
                        'D4', 'E4', 'F4', 'E4', 'C4',
                        'D4', 'E4', 'F4', 'E4', 'C4',
                        'C4', 'D4',
                        'E4', 'E4', 'F4', 'G4',
                        'G4', 'F4', 'E4', 'D4',
                        'C4', 'C4', 'D4', 'E4',
                        'E4', 'D4', 'D4',
                        'E4', 'E4', 'F4', 'G4',
                        'G4', 'F4', 'E4', 'D4',
                        'C4', 'C4', 'D4', 'E4',
                        'D4', 'C4','C4'];
        var mainState = {
            preload: function () {
                game.load.image('tile', 'tile.png');
                game.load.image('tileW', 'tileW.png');
                game.load.audio('C4', 'C4.ogg');
                game.load.audio('D4', 'D4.ogg');
                game.load.audio('E4', 'E4.ogg');
                game.load.audio('F4', 'F4.ogg');
                game.load.audio('G4', 'G4.ogg');
                
            },

            create: function () {
                this.start = false;
                this.vertical = 0;
                this.whiteTiles = game.add.group();
                this.blackTiles = game.add.group();
                this.tileSpeed = 0;
                this.horizontal = 0;
                this.counter = 0;
                this.freezeCheck = 0;
                this.isFreezed = true;
                this.currentTile = 0;
                for (i = yrec; i >= 0; i--) {
                    for (j = 0; j < xrec; j++) {
                        var rectangle = game.add.graphics(j * 100, i * 170);
                        rectangle.beginFill(0xffffff);
                        rectangle.lineStyle(0.5, 0x000000, 1);
                        rectangle.moveTo(0, 0);
                        rectangle.lineTo(100, 0);
                        rectangle.lineTo(100, 170);
                        rectangle.lineTo(0, 170);
                        rectangle.endFill();
                        this.whiteTiles.add(rectangle);
                    }


                    var rand = Math.floor(Math.random() * 4),
                        blackRectangle = game.add.graphics(rand * 100, i * 170);
                    blackRectangle.beginFill(0x000000);
                    blackRectangle.lineStyle(0.5, 0x000000, 1);
                    blackRectangle.moveTo(0, 0);
                    blackRectangle.lineTo(100, 0);
                    blackRectangle.lineTo(100, 170);
                    blackRectangle.lineTo(0, 170);
                    blackRectangle.endFill();
                    this.blackTiles.add(blackRectangle);
                    if (i === 3) {
                        this.lose = game.add.button(0, 510, 'tileW', this.taplose, this, 6, 4, 6, 4);
                        this.control = game.add.button(rand * 100, 510, 'tile', this.tap, this, 6, 4, 6, 4);
                    }
                    this.noteCounter = 0;
                    this.sound = game.add.audio('E4');
                }
                this.lose.alpha = 0;
                this.control.alpha = 0;
            },
            update: function () {
                this.whiteTiles.forEach(this.setSpeed, this, true);
                this.blackTiles.forEach(this.setSpeed, this, true);
                this.whiteTiles.forEach(this.checkWhiteTile, this, true);
                this.blackTiles.forEach(this.checkTile, this, true);
                this.lose.y += this.tileSpeed;
                this.control.y += this.tileSpeed;
                this.blackTiles.forEach(this.freeze, this, true);
                if (this.tileSpeed != 0) {
                    this.isFreezed = false;
                }

            },
            tap: function () {
                console.log('go on!');
                this.sound.stop();
                this.freezeCheck++;
                this.sound = game.add.audio(odeToJoy[this.noteCounter]);
                this.sound.play();
                this.noteCounter++;
                if (this.noteCounter === odeToJoy.length) {
                    this.noteCounter = 0;
                }
                //console.log(this.freezeCheck);
                this.currentTile++;
                this.counter = 0;
                this.tileSpeed = 17;
                this.blackTiles.forEach(this.search, this, true);

                for (j = 0; j < xrec; j++) {
                    var rectangle = game.add.graphics(j * 100, this.vertical - 170);
                    rectangle.beginFill(0xffffff);
                    rectangle.lineStyle(0.5, 0x000000, 1);
                    rectangle.moveTo(0, 0);
                    rectangle.lineTo(100, 0);
                    rectangle.lineTo(100, 170);
                    rectangle.lineTo(0, 170);
                    rectangle.endFill();
                    this.whiteTiles.add(rectangle);
                }
                var rand = Math.floor(Math.random() * 4),
                    blackRectangle = game.add.graphics(rand * 100, this.vertical - 170);
                blackRectangle.beginFill(0x000000);
                blackRectangle.lineStyle(0.5, 0x000000, 1);
                blackRectangle.moveTo(0, 0);
                blackRectangle.lineTo(100, 0);
                blackRectangle.lineTo(100, 170);
                blackRectangle.lineTo(0, 170);
                blackRectangle.endFill();
                this.blackTiles.add(blackRectangle);

                this.lose.y -= 170;
                this.control.x = this.horizontal;
                this.control.y -= 170;
            },
            search: function (tile) {
                this.vertical = tile.y;

                if (this.counter === this.currentTile + 1) {
                    this.horizontal = tile.x;
                }

                this.counter++;
            },
            taplose: function () {
                console.log('game over');
            },
            freeze: function (tile) {
                if (tile.y === game.height) {
                    if (this.freezeCheck > 0) {
                        if (!this.isFreezed) {
                            this.freezeCheck--;
                            this.isFreezed = true;
                        }
                        //console.log(this.isFreezed)
                    }
                    //console.log(this.freezeCheck);
                    if (this.freezeCheck === 0) {
                        this.tileSpeed = 0;
                    }
                }
            },
            setSpeed: function (tile) {
                tile.y += this.tileSpeed;
            },
            checkTile: function (tile) {
                if (tile.y > game.height) {
                    this.currentTile--;
                    tile.destroy();
                }
            },
            checkWhiteTile: function (tile) {
                if (tile.y > game.height) {
                    tile.destroy();
                }
            },

        };
        game = new Phaser.Game(400, 680, Phaser.CANVAS, 'gameDiv');
        game.state.add('mainstate', mainState);
        game.state.start('mainstate');

        /***********************************************************************************************/
    </script>
</body>

</html>