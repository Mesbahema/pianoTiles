<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>pianoTiles</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/2.4.3/custom/phaser-arcade-physics.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <style>
        body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        canvas {
            position: relative;
            margin: auto;
            right: 0;
        }
    </style>
</head>

<body>
    <script>
        var xrec = 4,
            yrec = 4,
            odeToJoy = ['E4', 'E4', 'F4', 'G4',
                'G4', 'F4', 'E4', 'D4',
                'C4', 'C4', 'D4', 'E4',
                'E4', 'D4', 'D4',
                'E4', 'E4', 'F4', 'G4',
                'G4', 'F4', 'E4', 'D4',
                'C4', 'C4', 'D4', 'E4',
                'E4', 'D4', 'D4',
                'D4', 'D4', 'E4', 'C4',
                'D4', 'E4', 'F4', 'E4', 'C4',
                'D4', 'E4', 'F4', 'E4', 'C4',
                'C4', 'D4',
                'E4', 'E4', 'F4', 'G4',
                'G4', 'F4', 'E4', 'D4',
                'C4', 'C4', 'D4', 'E4',
                'E4', 'D4', 'D4',
                'E4', 'E4', 'F4', 'G4',
                'G4', 'F4', 'E4', 'D4',
                'C4', 'C4', 'D4', 'E4',
                'D4', 'C4', 'C4'];
        var mainState = {
            preload: function () {
                game.load.image('tile', 'tile.png');
                game.load.image('grayTile', 'grayTile.png');
                game.load.image('redTile', 'redTile.png');
                game.load.audio('false', 'false.ogg');
                game.load.audio('C4', 'C4.ogg');
                game.load.audio('D4', 'D4.ogg');
                game.load.audio('E4', 'E4.ogg');
                game.load.audio('F4', 'F4.ogg');
                game.load.audio('G4', 'G4.ogg');

            },

            create: function () {
                this.randomArray = [0.001, 0.002, 0.003, 0.004, 0.005, 0.006, 0.007, 0.008, 0.009];
                this.game_over = false;
                this.isStarted = false;
                this.countTile = 0;
                this.interval = 0;
                this.time = 0;
                this.start = false;
                this.vertical = 0;
                this.background = game.add.graphics(0, 0);
                this.background.beginFill(0x08fb03);
                //this.background.lineStyle(0.5, 0x000000, 1);
                this.background.moveTo(0, 0);
                this.background.lineTo(400, 0);
                this.background.lineTo(400, 680);
                this.background.lineTo(0, 680);
                this.background.endFill();
                this.whiteTiles = game.add.group();
                this.redTiles = game.add.group();
                this.blackTiles = game.add.group();
                this.grayTiles = game.add.group();
                this.timeText = game.add.text(200, 50, "0", {
                    font: "40px iran_sans",
                    fill: "#f44242"
                });
                this.timeText.anchor.setTo(0.5);
                this.timeText.text = '0.000"';
                this.finalTime = game.add.text(game.world.centerX, game.world.centerY, "0", {
                    font: "80px iran_sans",
                    fill: "#000000"
                });
                this.finalTime.anchor.setTo(0.5, 0.5);
                //this.finalTime.text = '0.000"';
                this.finalTime.visible = false;
                this.tileSpeed = 0;
                this.horizontal = 0;
                this.counter = 0;
                this.freezeCheck = 0;
                this.isFreezed = true;
                this.currentTile = 0;
                this.sound = game.add.audio('E4');
                this.false = game.add.audio('false');
                for (i = yrec; i >= 0; i--) {
                    for (j = 0; j < xrec; j++) {
                        var rectangle = game.add.graphics(j * 100, i * 170);
                        rectangle.beginFill(0xffffff);
                        rectangle.lineStyle(0.5, 0x000000, 1);
                        rectangle.moveTo(0, 0);
                        rectangle.lineTo(100, 0);
                        rectangle.lineTo(100, 170);
                        rectangle.lineTo(0, 170);
                        rectangle.endFill();
                        this.whiteTiles.add(rectangle);




                    }
                    this.countTile++;

                    var rand = Math.floor(Math.random() * 4),
                        blackRectangle = game.add.graphics(rand * 100, i * 170);
                    blackRectangle.beginFill(0x000000);
                    blackRectangle.lineStyle(0.5, 0x000000, 1);
                    blackRectangle.moveTo(0, 0);
                    blackRectangle.lineTo(100, 0);
                    blackRectangle.lineTo(100, 170);
                    blackRectangle.lineTo(0, 170);
                    blackRectangle.endFill();
                    this.blackTiles.add(blackRectangle);
                    if (i === 3) {
                        this.control = game.add.button(rand * 100, 510, 'tile', this.tap, this, 6, 4, 6, 4);
                    }
                    this.noteCounter = 0;
                }
                this.redTile1 = game.add.button(0, 510, 'redTile', this.taplose1, this, 6, 4, 6, 4);
                this.redTile2 = game.add.button(100, 510, 'redTile', this.taplose2, this, 6, 4, 6, 4);
                this.redTile3 = game.add.button(200, 510, 'redTile', this.taplose3, this, 6, 4, 6, 4);
                this.redTile4 = game.add.button(300, 510, 'redTile', this.taplose4, this, 6, 4, 6, 4);
                this.redTiles.add(this.redTile1);
                this.redTiles.add(this.redTile2);
                this.redTiles.add(this.redTile3);
                this.redTiles.add(this.redTile4);
                this.redTile1.alpha = 0;
                this.redTile2.alpha = 0;
                this.redTile3.alpha = 0;
                this.redTile4.alpha = 0;
                this.control.alpha = 0;
            },
            update: function () {
                if (!this.game_over) {
                    if (this.isStarted) {
                        this.time += 0.0166666666666;
                        this.time = Math.floor(this.time * 1000) / 1000;
                        if ((this.time * 1000) % 10 === 0) {
                            this.time += 0.001;
                        }
                        this.timeText.text = this.time + '"';
                    }
                    this.interval += 1;
                    this.whiteTiles.forEach(this.setSpeed, this, true);
                    this.blackTiles.forEach(this.setSpeed, this, true);
                    this.redTiles.forEach(this.setSpeed, this, true);
                    this.grayTiles.forEach(this.setSpeed, this, true);
                    this.whiteTiles.forEach(this.checkWhiteTile, this, true);
                    this.blackTiles.forEach(this.checkTile, this, true);
                    this.control.y += this.tileSpeed;
                    this.blackTiles.forEach(this.freeze, this, true);
                    if (this.tileSpeed != 0) {
                        this.isFreezed = false;
                    }
                }
            },
            tap: function () {
                if (!this.game_over) {
                    this.isStarted = true;
                    this.sound.stop();
                    this.freezeCheck++;
                    this.sound = game.add.audio(odeToJoy[this.noteCounter]);
                    this.sound.volume = 0.5;
                    this.sound.play();
                    this.noteCounter++;
                    if (this.noteCounter === odeToJoy.length) {
                        this.noteCounter = 0;
                    }
                    this.currentTile++;
                    this.counter = 0;
                    this.tileSpeed = 17;
                    this.blackTiles.forEach(this.search, this, true);
                    this.countTile++;
                    var grayTile;
                    grayTile = game.add.sprite(this.control.x, this.control.y, 'grayTile');
                    this.grayTiles.add(grayTile);
                    if (this.countTile <= 25) {
                        for (j = 0; j < xrec; j++) {
                            var rectangle = game.add.graphics(j * 100, this.vertical - 170);
                            rectangle.beginFill(0xffffff);
                            rectangle.lineStyle(0.5, 0x000000, 1);
                            rectangle.moveTo(0, 0);
                            rectangle.lineTo(100, 0);
                            rectangle.lineTo(100, 170);
                            rectangle.lineTo(0, 170);
                            rectangle.endFill();
                            this.whiteTiles.add(rectangle);
                        }
                        var rand = Math.floor(Math.random() * 4),
                            blackRectangle = game.add.graphics(rand * 100, this.vertical - 170);
                        blackRectangle.beginFill(0x000000);
                        blackRectangle.lineStyle(0.5, 0x000000, 1);
                        blackRectangle.moveTo(0, 0);
                        blackRectangle.lineTo(100, 0);
                        blackRectangle.lineTo(100, 170);
                        blackRectangle.lineTo(0, 170);
                        blackRectangle.endFill();
                        this.blackTiles.add(blackRectangle);
                    }
                    this.redTiles.forEach(this.redTileMove, this, true);
                    this.control.x = this.horizontal;
                    this.control.y -= 170;
                }
            },
            redTileMove: function (tile) {
                tile.y -= 170;
            },
            search: function (tile) {
                this.vertical = tile.y;

                if (this.counter === this.currentTile + 1) {
                    this.horizontal = tile.x;
                }

                this.counter++;
            },
            taplose1: function () {
                if (!this.game_over) {
                    this.redTile1.alpha = 1;
                    this.gameOver();
                }
            },
            taplose2: function () {
                if (!this.game_over) {
                    this.redTile2.alpha = 1;
                    this.gameOver();
                }
            },
            taplose3: function () {
                if (!this.game_over) {
                    this.redTile3.alpha = 1;
                    this.gameOver();
                }
            },
            taplose4: function () {
                if (!this.game_over) {
                    this.redTile4.alpha = 1;
                    this.gameOver();
                }
            },
            freeze: function (tile) {
                if (tile.y === game.height) {
                    if (this.freezeCheck >= 1) {
                        if (!this.isFreezed) {
                            this.freezeCheck--;
                            this.isFreezed = true;
                        }
                    }
                    console.log(this.freezeCheck);
                    if (this.freezeCheck === 0) {
                        this.tileSpeed = 0;
                        //this.isFreezed = true;
                        if (this.countTile === 29) {
                            this.Success();

                        }
                    }
                }
            },
            setSpeed: function (tile) {
                tile.y += this.tileSpeed;
            },
            checkTile: function (tile) {
                if (tile.y > game.height) {
                    this.currentTile--;
                    tile.destroy();
                }
            },
            checkWhiteTile: function (tile) {
                if (tile.y > game.height) {
                    tile.destroy();
                }
            },
            gameOver: function () {
                this.false.play();
                this.sound.destroy();
                this.game_over = true;
            },
            Success: function () {
                this.game_over = true;
                this.timeText.visible = false;
                this.finalTime.visible = true;
                this.finalTime.text = this.time;
                this.whiteTiles.forEach(this.moveTile, this, true);
                this.blackTiles.forEach(this.moveTile, this, true);
                this.grayTiles.forEach(this.moveTile, this, true);
                this.redTiles.forEach(this.moveTile, this, true);              
                this.sound.destroy();
            },
            moveTile: function(tile) {
                tile.y += 1700;
            },
        };
        game = new Phaser.Game(400, 680, Phaser.CANVAS, 'gameDiv');
        game.state.add('mainstate', mainState);
        game.state.start('mainstate');

        /***********************************************************************************************/
    </script>
</body>

</html>